import 'package:google_generative_ai/google_generative_ai.dart';
import '../config/api_config.dart';

class GeminiService {
  late final GenerativeModel _model;
  late ChatSession _chat;
  final List<Content> _history = [];
  bool _isInitialized = false;

  GeminiService() {
    try {
      _initializeModel();
      _isInitialized = true;
    } catch (e) {
      _isInitialized = false;
      rethrow;
    }
  }

  void _initializeModel() {
    _model = GenerativeModel(
      model: 'gemini-pro',
      apiKey: ApiConfig.apiKey,
      // ‚Üê QUITADO: systemInstruction (no compatible con v1beta)
      generationConfig: GenerationConfig(
        temperature: 0.9,
        topK: 40,
        topP: 0.95,
        maxOutputTokens: 1024,
      ),
    );

    // ‚Üê NUEVO: Agregar contexto como primer mensaje del historial
    _history.add(
      Content.model([
        TextPart(
          'üêÑ Soy Bovara Assistant, un experto asistente de IA especializado en ganader√≠a. '
              'Ayudo a ganaderos con an√°lisis de producci√≥n, calendarios de vacunaci√≥n, '
              'registro de pesajes, recomendaciones de manejo, alertas sanitarias, '
              'nutrici√≥n y reproducci√≥n. Respondo de forma clara, concisa y pr√°ctica.',
        ),
      ]),
    );

    _chat = _model.startChat(history: _history);
  }

  Future<GeminiResponse> sendMessage(String message) async {
    if (!_isInitialized) {
      return GeminiResponse(
        text: 'Error: El asistente no est√° inicializado correctamente. '
            'Verifica tu API key de Gemini.',
        success: false,
        error: 'Service not initialized',
      );
    }

    try {
      final response = await _chat.sendMessage(Content.text(message));
      final text = response.text ?? 'No pude generar una respuesta.';

      return GeminiResponse(
        text: text,
        success: true,
      );
    } on GenerativeAIException catch (e) {
      String errorMessage;

      if (e.message.contains('API_KEY_INVALID') || e.message.contains('API key not valid')) {
        errorMessage = 'üîë API Key inv√°lida\n\n'
            'Por favor configura una API key v√°lida en:\n'
            'lib/src/core/config/api_config.dart\n\n'
            'Obt√©n tu key en:\n'
            'https://aistudio.google.com/app/apikey';
      } else if (e.message.contains('quota')) {
        errorMessage = '‚ö†Ô∏è Cuota excedida\n\n'
            'Has alcanzado el l√≠mite de uso de la API de Gemini.\n'
            'Espera un momento o verifica tu cuenta.';
      } else if (e.message.contains('not found') || e.message.contains('not supported')) {
        errorMessage = '‚ö†Ô∏è Modelo no disponible\n\n'
            'El modelo solicitado no est√° disponible.\n'
            'Intenta con otro modelo o verifica tu configuraci√≥n.';
      } else {
        errorMessage = '‚ùå Error de Gemini API\n\n${e.message}';
      }

      return GeminiResponse(
        text: errorMessage,
        success: false,
        error: e.message,
      );
    } catch (e) {
      return GeminiResponse(
        text: '‚ùå Error inesperado\n\n$e',
        success: false,
        error: e.toString(),
      );
    }
  }

  List<Content> get history => _history;

  void clearHistory() {
    _history.clear();

    // Volver a agregar el contexto inicial
    _history.add(
      Content.model([
        TextPart(
          'üêÑ Soy Bovara Assistant, un experto asistente de IA especializado en ganader√≠a. '
              'Ayudo a ganaderos con an√°lisis de producci√≥n, calendarios de vacunaci√≥n, '
              'registro de pesajes, recomendaciones de manejo, alertas sanitarias, '
              'nutrici√≥n y reproducci√≥n. Respondo de forma clara, concisa y pr√°ctica.',
        ),
      ]),
    );

    if (_isInitialized) {
      _chat = _model.startChat(history: _history);
    }
  }
}

class GeminiResponse {
  final String text;
  final bool success;
  final String? error;

  GeminiResponse({
    required this.text,
    required this.success,
    this.error,
  });
}
